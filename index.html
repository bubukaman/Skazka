<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Генератор сказки</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #0a0a0a;
      color: #ddd;
    }
    header {
      background: #003366;
      padding: 1em;
      text-align: center;
      font-size: 1.5em;
      color: #fff;
    }
    main {
      padding: 1em;
    }
    button {
      padding: 0.5em 1em;
      margin: 0.5em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn-main {
      background: #0055aa;
      color: #fff;
    }
    .editor, .question-setup, .presentation, .settings {
      display: none;
      margin-top: 1em;
    }
    #paper {
      background: #fff;
      color: #000;
      padding: 1em;
      border-radius: 8px;
      min-height: 200px;
      max-height: 300px;
      overflow-y: auto;
    }
    .number {
      color: red;
      font-weight: bold;
    }
    .input-field {
      display: block;
      margin: 0.5em 0;
      padding: 0.5em;
      width: 100%;
    }
  </style>
</head>
<body>
  <header>Генератор сказки</header>
  <main>
    <div id="menu">
      <button class="btn-main" onclick="startEditor()">Создать сказку</button>
      <button class="btn-main" onclick="loadStory()">Загрузить сказку</button>
    </div>

    <div class="editor">
      <div id="paper" onclick="editElement(event)"></div>
      <button onclick="addText()">Добавить текст</button>
      <button onclick="addNumber()">Добавить число</button>
      <button onclick="toQuestions()">Дальше</button>
    </div>

    <div class="question-setup">
      <h3>Введите вопросы для переменных:</h3>
      <div id="questions"></div>
      <button onclick="backToEditor()">Назад</button>
      <button onclick="toSettings()">Дальше</button>
    </div>

    <div class="settings">
      <h3>Настройки сказки</h3>
      <label><input type="checkbox" id="randomOrder" /> Вопросы в случайном порядке</label><br>
      <input class="input-field" id="bgColor" placeholder="Фон (hex)" value="#000000" />
      <input class="input-field" id="paperColor" placeholder="Цвет листка (hex)" value="#ffffff" />
      <input class="input-field" id="textColor" placeholder="Цвет текста (hex)" value="#000000" />
      <input class="input-field" id="nickname" placeholder="Ваш ник" />
      <textarea class="input-field" id="description" placeholder="Описание (необязательно)"></textarea>
      <button onclick="generateCode()">Готово</button>
    </div>

    <div class="presentation">
      <h3 id="presentNickname"></h3>
      <p id="presentDescription"></p>
      <div id="presentPaper" style="padding:1em;border-radius:8px;"></div>
    </div>
  </main>

  <script>
    let storyParts = [];
    let numbers = [];
    let questions = {};

    function startEditor() {
      document.getElementById('menu').style.display = 'none';
      document.querySelector('.editor').style.display = 'block';
    }

    function loadStory() {
      const code = prompt("Вставьте код сказки:");
      if (code) {
        try {
          const data = JSON.parse(atob(code));
          runTest(data);
        } catch {
          alert("Неверный код!");
        }
      }
    }

    function addText() {
      const text = prompt("Введите текст:");
      if (text) {
        storyParts.push({ type: "text", value: text });
        renderStory();
      }
    }

    function addNumber() {
      const num = numbers.length + 1;
      storyParts.push({ type: "number", value: num });
      numbers.push(num);
      renderStory();
    }

    function renderStory() {
      const paper = document.getElementById("paper");
      paper.innerHTML = storyParts.map(part => {
        if (part.type === "text") {
          return `<span>${part.value}</span>`;
        } else {
          return `<span class="number">{${part.value}}</span>`;
        }
      }).join(" ");
    }

    function editElement(event) {
      if (event.target.tagName === "SPAN") {
        const oldText = event.target.textContent;
        const newText = prompt("Измените текст:", oldText);
        if (newText !== null) {
          for (let part of storyParts) {
            if (part.type === "text" && part.value === oldText) {
              part.value = newText;
              break;
            }
          }
          renderStory();
        }
      }
    }

    function toQuestions() {
      document.querySelector('.editor').style.display = 'none';
      document.querySelector('.question-setup').style.display = 'block';
      const qDiv = document.getElementById('questions');
      qDiv.innerHTML = '';
      numbers.forEach(num => {
        qDiv.innerHTML += `<input class="input-field" placeholder="Вопрос для {${num}}" id="q${num}">`;
      });
    }

    function backToEditor() {
      document.querySelector('.question-setup').style.display = 'none';
      document.querySelector('.editor').style.display = 'block';
    }

    function toSettings() {
      numbers.forEach(num => {
        const qVal = document.getElementById(`q${num}`).value;
        if (!qVal) {
          alert(`Заполните вопрос для {${num}}`);
          throw new Error("Не все вопросы заполнены");
        }
        questions[num] = qVal;
      });
      document.querySelector('.question-setup').style.display = 'none';
      document.querySelector('.settings').style.display = 'block';
    }

    function generateCode() {
      const data = {
        storyParts,
        questions,
        settings: {
          randomOrder: document.getElementById('randomOrder').checked,
          bgColor: document.getElementById('bgColor').value,
          paperColor: document.getElementById('paperColor').value,
          textColor: document.getElementById('textColor').value,
          nickname: document.getElementById('nickname').value,
          description: document.getElementById('description').value
        }
      };
      const code = btoa(JSON.stringify(data));
      alert("Ваш код:\n" + code);
    }

    function runTest(data) {
      document.getElementById('menu').style.display = 'none';
      const presentation = document.querySelector('.presentation');
      presentation.style.display = 'block';
      document.body.style.background = data.settings.bgColor;
      const paper = document.getElementById('presentPaper');
      paper.style.background = data.settings.paperColor;
      paper.style.color = data.settings.textColor;
      document.getElementById('presentNickname').textContent = data.settings.nickname || "";
      document.getElementById('presentDescription').textContent = data.settings.description || "";

      let answers = {};
      let qNumbers = Object.keys(data.questions);
      if (data.settings.randomOrder) {
        qNumbers = qNumbers.sort(() => Math.random() - 0.5);
      }

      function askNext(index) {
        if (index >= qNumbers.length) {
          showStory();
          return;
        }
        const qNum = qNumbers[index];
        const answer = prompt(data.questions[qNum]);
        answers[qNum] = answer;
        askNext(index + 1);
      }

      function showStory() {
        paper.innerHTML = data.storyParts.map(part => {
          if (part.type === "text") {
            return `<span>${part.value}</span>`;
          } else {
            return `<span class="number">${answers[part.value]}</span>`;
          }
        }).join(" ");
      }

      askNext(0);
    }
  </script>
</body>
</html>
